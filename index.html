<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Training Budget Calculator</title>
    <script src="libs/papaparse.min.js"></script>
    <script src="libs/chart.umd.min.js"></script>
    <script src="libs/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #1a1a1a; line-height: 1.6; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 40px; padding: 40px 20px; background: white; border-radius: 8px; position: relative; }
        .header h1 { font-size: 2.5em; color: #1e40af; font-weight: 700; margin-bottom: 10px; }
        .header p { font-size: 1.1em; color: #666; }
        .hamburger-menu { position: absolute; top: 20px; right: 20px; cursor: pointer; z-index: 1000; }
        .hamburger-icon { width: 30px; height: 24px; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger-icon span { width: 100%; height: 3px; background: #1e40af; border-radius: 2px; transition: all 0.3s; }
        .menu-dropdown { position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #d0d0d0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 200px; display: none; z-index: 999; }
        .menu-dropdown.open { display: block; }
        .menu-item { padding: 12px 20px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background: #f0f5ff; }
        .menu-item-icon { font-size: 1.2em; }
        .menu-item-text { font-size: 0.95em; color: #333; }
        .hidden-file-input { display: none; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .panel { background: white; border-radius: 8px; padding: 40px; }
        .panel h2 { font-size: 1.5em; color: #1a1a1a; margin-bottom: 10px; font-weight: 700; }
        .panel-subtitle { font-size: 0.95em; color: #666; margin-bottom: 30px; }
        .section-title { font-size: 1.1em; color: #1a1a1a; font-weight: 600; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; }
        .section-title:first-of-type { margin-top: 0; }
        .input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; gap: 20px; }
        .input-label { flex: 1; font-size: 0.95em; color: #333; }
        .input-wrapper { display: flex; align-items: center; gap: 10px; }
        .input-field { width: 90px; padding: 8px 12px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 0.95em; }
        .input-field:read-only { background: #f5f5f5; }
        .input-unit { font-size: 0.9em; color: #666; min-width: 60px; }
        .file-upload { border: 2px dashed #d0d0d0; border-radius: 8px; padding: 40px 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafafa; margin: 20px 0; }
        .file-upload:hover { border-color: #1e40af; background: #f0f5ff; }
        .file-upload input { display: none; }
        .upload-icon { font-size: 2.5em; margin-bottom: 10px; color: #1e40af; }
        .file-upload h3 { color: #1a1a1a; margin-bottom: 8px; font-weight: 600; }
        .file-upload p { color: #666; font-size: 0.9em; }
        .file-uploaded { background: #f0fdf4; border-color: #10b981; }
        .file-upload-error { background: #fef2f2; border-color: #ef4444; }
        select.input-field { width: auto; min-width: 200px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 9px center; padding-right: 26px; }
        .aircraft-item { display: grid; grid-template-columns: 112px 65px 1fr auto; gap: 15px; padding: 12px; background: #fafafa; border-radius: 6px; margin-bottom: 10px; align-items: center; }
        .aircraft-rate-section { display: flex; align-items: center; gap: 8px; }
        .aircraft-item-row2 { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: start; }
        .hour-input-group { display: flex; flex-direction: column; gap: 5px; }
        .hour-input-group label { font-size: 0.85em; color: #666; }
        .hour-input-row { display: flex; align-items: center; gap: 5px; }
        .hour-input { width: 75px !important; }
        .hour-cost-display { font-size: 0.8em; color: #1e40af; font-weight: 600; margin-top: 2px; }
        .aircraft-id { width: 112px; text-align: center; font-weight: 500; }
        .aircraft-rate-type { width: 65px !important; min-width: 65px !important; font-size: 0.9em; padding: 8px 6px; padding-right: 22px; }
        .aircraft-base-rate { width: 80px !important; }
        .fuel-inputs { display: flex; gap: 10px; grid-column: 1 / -1; }
        .fuel-inputs.hidden { display: none; }
        .fuel-price, .fuel-burn { width: 60px !important; }
        .btn-remove { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; }
        .btn-add { background: #1e40af; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; margin-top: 10px; }
        .btn-export { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; margin-top: 10px; }
        .summary-card { background: white; border-radius: 8px; padding: 30px; margin-bottom: 20px; }
        .summary-card h2 { font-size: 1.5em; margin-bottom: 25px; font-weight: 700; }
        .summary-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .summary-label { font-size: 0.95em; color: #333; }
        .summary-value { font-size: 1.1em; font-weight: 600; }
        .total-section { background: #1e40af; color: white; padding: 25px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .total-amount { font-size: 2.5em; font-weight: 700; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: #fafafa; padding: 15px; border-radius: 6px; }
        .stat-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 1.5em; font-weight: 700; color: #1e40af; }
        .chart-container { position: relative; width: 100%; max-width: 350px; margin: 30px auto; }
        .chart-legend { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .legend-color { width: 16px; height: 16px; border-radius: 3px; }
        .legend-label { flex: 1; color: #666; }
        .legend-value { font-weight: 600; }
        .collapsible-header { background: #f8f9fa; padding: 15px 20px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; margin-top: 20px; }
        .collapsible-header:hover { background: #e9ecef; }
        .collapsible-title { font-weight: 600; }
        .collapsible-icon { transition: transform 0.3s; }
        .collapsible-icon.open { transform: rotate(180deg); }
        .collapsible-content { display: none; padding: 20px 0; }
        .collapsible-content.open { display: block; }
        .requirement-item { background: #fafafa; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #d0d0d0; }
        .requirement-item.completed { border-left-color: #10b981; background: #f0fdf4; }
        .requirement-item.in-progress { border-left-color: #f59e0b; background: #fffbeb; }
        .requirement-item.not-started { border-left-color: #ef4444; background: #fef2f2; }
        .requirement-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .requirement-title { font-weight: 600; }
        .requirement-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; }
        .badge-completed { background: #10b981; color: white; }
        .badge-in-progress { background: #f59e0b; color: white; }
        .badge-not-started { background: #ef4444; color: white; }
        .requirement-stats { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.85em; color: #666; }
        .requirement-breakdown { font-size: 0.8em; color: #666; margin-top: 8px; font-style: italic; }
        .progress-bar { width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #1e40af; transition: width 0.5s; }
        
        @media print {
            body { background: white; }
            .header { page-break-after: avoid; }
            .btn-export { display: none; }
            .file-upload { display: none; }
            .panel { page-break-inside: avoid; }
            .summary-card { page-break-inside: avoid; }
            @page { margin: 0.5in; }
        }
        
        @media (max-width: 1024px) { .grid-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>Flight Training Budget Calculator</h1>
            <p>Calculate the cost to complete your next certification</p>
            
            <div class="hamburger-menu" id="hamburgerMenu">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="menu-dropdown" id="menuDropdown">
                <div class="menu-item" id="saveBudgetBtn">
                    <span class="menu-item-icon">ðŸ’¾</span>
                    <span class="menu-item-text">Save Budget</span>
                </div>
                <div class="menu-item" id="loadBudgetBtn">
                    <span class="menu-item-icon">ðŸ“‚</span>
                    <span class="menu-item-text">Load Budget</span>
                </div>
            </div>
            
            <input type="file" id="budgetFileInput" class="hidden-file-input" accept=".json">
        </div>

        <div class="grid-layout">
            <div class="panel">
                <h2>1. Plan Your Training</h2>
                <p class="panel-subtitle">Import logbook to see progress. Enter planned hours for remaining training.</p>

                <div class="section-title">Import Your Progress (Optional)</div>
                
                <div class="file-upload" id="fileUploadArea" onclick="document.getElementById('logbookFile').click()">
                    <input type="file" id="logbookFile" accept=".csv">
                    <div class="upload-icon">ðŸ“Š</div>
                    <h3>Import ForeFlight Logbook</h3>
                    <p>See your current hours and what you still need</p>
                </div>

                <div class="input-row">
                    <div class="input-label">Certification:</div>
                    <select class="input-field" id="targetCert">
                        <option value="">None</option>
                        <option value="ir">Instrument Rating (Part 61)</option>
                        <option value="cpl">Commercial Pilot License (Part 61)</option>
                        <option value="cfi">Certified Flight Instructor</option>
                    </select>
                </div>

                <div class="section-title">Aircraft Rental Rates</div>
                
                <div id="aircraftList"></div>
                <button class="btn-add" id="addAircraftBtn">+ Add Aircraft</button>

                <div class="section-title">Financial & Time Planning</div>
                
                <div class="input-row">
                    <div class="input-label">Training Pace (Lessons per week)</div>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="lessonsPerWeek" value="2" min="1" max="7" step="0.5">
                        <span class="input-unit">lessons/week</span>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 20px; text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 0.95em; color: #666; margin-bottom: 8px;">Est. Time to Completion</div>
                        <div style="font-size: 2em; font-weight: 700; color: #1e40af;" id="estimatedMonths">~ 0 Months</div>
                    </div>
                    <div>
                        <div style="font-size: 0.95em; color: #666; margin-bottom: 8px;">Est. Monthly Budget</div>
                        <div style="font-size: 2em; font-weight: 700; color: #1e40af;" id="monthlyBudget">$0.00</div>
                    </div>
                </div>

                <div class="section-title">Other Hourly Rates</div>
                
                <div class="input-row">
                    <div class="input-label">Flight/Ground Instruction</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="instructorRate" value="60">
                        <span class="input-unit">per hour</span>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Flight Simulator</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="simulatorRate" value="105">
                        <span class="input-unit">per hour</span>
                    </div>
                </div>

                <div class="section-title">Planned Training Hours</div>
                
                <div class="input-row">
                    <div class="input-label">Total Dual Hours (Planned)</div>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="dualHours" value="0" readonly>
                        <span class="input-unit">hours</span>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Total Solo Hours (Planned)</div>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="soloHours" value="0" readonly>
                        <span class="input-unit">hours</span>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Ground Instruction Hours</div>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="groundHours" value="0">
                        <span class="input-unit">hours</span>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Additional Personal Hours</div>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="familyHours" value="0" readonly>
                        <span class="input-unit">hours</span>
                    </div>
                </div>

                <div class="section-title">Gear & Supplies</div>
                
                <div class="input-row">
                    <div class="input-label">Aviation Headset</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="headsetCost" value="0">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Ground School / Books</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="booksCost" value="0">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Flight Supplies</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="bagCost" value="0">
                    </div>
                </div>

                <div class="section-title">Exams & Fees</div>
                
                <div class="input-row">
                    <div class="input-label">Aviation Medical Exam</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="medicalCost" value="300">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">FAA Knowledge Test</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="knowledgeCost" value="250">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Practical Exam (Checkride)</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="checkrideCost" value="1000">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Renter's Insurance (Annual)</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="insuranceCost" value="1150">
                    </div>
                </div>

                <div class="section-title">Subscriptions (Annual)</div>
                
                <div class="input-row">
                    <div class="input-label">ForeFlight / EFB</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="foreflightCost" value="275">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Online Ground School</div>
                    <div class="input-wrapper">
                        <span style="color: #999;">$</span>
                        <input type="number" class="input-field" id="onlineSchoolCost" value="0">
                    </div>
                </div>

                <div class="section-title">Contingency</div>
                
                <div class="input-row">
                    <div class="input-label">Contingency Fund (15-25%)</div>
                    <div class="input-wrapper">
                        <input type="number" class="input-field" id="contingencyPercent" value="20">
                        <span class="input-unit">%</span>
                    </div>
                </div>
            </div>

            <div>
                <div class="summary-card">
                    <h2>2. Your Training Budget</h2>
                    
                    <div class="summary-row">
                        <div class="summary-label">Flight Training:</div>
                        <div class="summary-value" id="flightTrainingCost">$0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Personal Flying:</div>
                        <div class="summary-value" id="familyFlightCost">$0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Gear & Supplies:</div>
                        <div class="summary-value" id="gearCost">$0.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Exams & Fees:</div>
                        <div class="summary-value" id="examsCost">$2,700.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Subscriptions:</div>
                        <div class="summary-value" id="subscriptionsCost">$275.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Subtotal:</div>
                        <div class="summary-value" id="subtotalCost">$2,975.00</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">Contingency Fund:</div>
                        <div class="summary-value" id="contingencyCost">$595.00</div>
                    </div>

                    <div class="total-section">
                        <h3>Total Budget Estimate</h3>
                        <div class="total-amount" id="totalCost">$3,570.00</div>
                        <button class="btn-export" id="exportPdfBtn">Export to PDF</button>
                    </div>
                </div>

                <div id="logbookSummary" class="summary-card" style="display: none;">
                    <h2>Your Current Hours</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Total Time</div>
                            <div class="stat-value" id="summaryTotalTime">0.0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">PIC Time</div>
                            <div class="stat-value" id="summaryPICTime">0.0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Cross Country</div>
                            <div class="stat-value" id="summaryXCTime">0.0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Dual Received</div>
                            <div class="stat-value" id="summaryDualTime">0.0</div>
                        </div>
                    </div>

                    <div class="collapsible-header" id="instrumentDetailsHeader">
                        <div class="collapsible-title">Instrument Time Details</div>
                        <div class="collapsible-icon" id="instrumentDetailsIcon">â–¼</div>
                    </div>
                    <div class="collapsible-content" id="instrumentDetails">
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label">Total Instrument</div>
                                <div class="stat-value" id="summaryInstrumentTime">0.0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Actual</div>
                                <div class="stat-value" id="summaryActualInstrument">0.0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Simulated</div>
                                <div class="stat-value" id="summarySimulatedInstrument">0.0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Simulator</div>
                                <div class="stat-value" id="summarySimTimeContainer"><span id="summarySimTime">0.0</span></div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Instrument Dual</div>
                                <div class="stat-value" id="summaryInstrumentDualAirplane">0.0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Recent (2mo)</div>
                                <div class="stat-value" id="summaryRecentInstrument">0.0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="budgetBreakdown" class="summary-card">
                    <h2>Budget Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="budgetChart"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>

                <div id="requirementsList" class="summary-card" style="display: none;">
                    <h2>Requirements Progress</h2>
                    <div id="requirementsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var budgetChart = null;
        var currentHours = {};
        var aircraftData = {};
        var preventAutoFill = false;
        var defaultAircraft = [
            { id: 'PA28-151', rate: 165, type: 'wet', fuelPrice: 6, fuelBurn: 8 },
            { id: 'C-172', rate: 165, type: 'wet', fuelPrice: 6, fuelBurn: 8 },
            { id: 'C-R182', rate: 235, type: 'wet', fuelPrice: 6, fuelBurn: 8 },
            { id: 'PA28-181', rate: 105, type: 'dry', fuelPrice: 6, fuelBurn: 11.5 }
        ];

        function toggleMenu() {
            var menu = document.getElementById('menuDropdown');
            menu.classList.toggle('open');
        }

        function saveBudget() {
            var budget = {
                version: '1.0',
                savedDate: new Date().toISOString(),
                currentHours: currentHours,
                settings: {
                    targetCert: document.getElementById('targetCert').value,
                    aircraft: [],
                    lessonsPerWeek: parseFloat(document.getElementById('lessonsPerWeek').value) || 2,
                    instructorRate: parseFloat(document.getElementById('instructorRate').value) || 60,
                    simulatorRate: parseFloat(document.getElementById('simulatorRate').value) || 105,
                    groundHours: parseFloat(document.getElementById('groundHours').value) || 0,
                    headsetCost: parseFloat(document.getElementById('headsetCost').value) || 0,
                    booksCost: parseFloat(document.getElementById('booksCost').value) || 0,
                    bagCost: parseFloat(document.getElementById('bagCost').value) || 0,
                    medicalCost: parseFloat(document.getElementById('medicalCost').value) || 300,
                    knowledgeCost: parseFloat(document.getElementById('knowledgeCost').value) || 250,
                    checkrideCost: parseFloat(document.getElementById('checkrideCost').value) || 1000,
                    insuranceCost: parseFloat(document.getElementById('insuranceCost').value) || 1150,
                    foreflightCost: parseFloat(document.getElementById('foreflightCost').value) || 275,
                    onlineSchoolCost: parseFloat(document.getElementById('onlineSchoolCost').value) || 0,
                    contingencyPercent: parseFloat(document.getElementById('contingencyPercent').value) || 20
                }
            };

            var aircraftItems = document.querySelectorAll('#aircraftList .aircraft-item');
            for (var i = 0; i < aircraftItems.length; i++) {
                var item = aircraftItems[i];
                var aircraft = {
                    id: item.querySelector('.aircraft-id').value,
                    rateType: item.querySelector('.aircraft-rate-type').value,
                    baseRate: parseFloat(item.querySelector('.aircraft-base-rate').value) || 0,
                    fuelPrice: parseFloat(item.querySelector('.fuel-price').value) || 0,
                    fuelBurn: parseFloat(item.querySelector('.fuel-burn').value) || 0,
                    dualHours: parseFloat(item.querySelector('.aircraft-dual-hours').value) || 0,
                    soloHours: parseFloat(item.querySelector('.aircraft-solo-hours').value) || 0,
                    familyHours: parseFloat(item.querySelector('.aircraft-family-hours').value) || 0
                };
                budget.settings.aircraft.push(aircraft);
            }

            var jsonStr = JSON.stringify(budget, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'flight-training-budget-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            document.getElementById('menuDropdown').classList.remove('open');
        }

        function loadBudget(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var budget = JSON.parse(e.target.result);
                    
                    if (!budget.settings) {
                        alert('Invalid budget file format.');
                        return;
                    }

                    if (budget.currentHours) {
                        currentHours = budget.currentHours;
                        
                        if (currentHours.totalTime && currentHours.totalTime > 0) {
                            document.getElementById('logbookSummary').style.display = 'block';
                            document.getElementById('summaryTotalTime').textContent = currentHours.totalTime.toFixed(1);
                            document.getElementById('summaryPICTime').textContent = currentHours.picTime.toFixed(1);
                            document.getElementById('summaryXCTime').textContent = currentHours.picXC.toFixed(1);
                            document.getElementById('summaryDualTime').textContent = currentHours.dualReceived.toFixed(1);
                            document.getElementById('summaryInstrumentTime').textContent = currentHours.instrumentTotal.toFixed(1);
                            document.getElementById('summaryActualInstrument').textContent = currentHours.actualInstrument.toFixed(1);
                            document.getElementById('summarySimulatedInstrument').textContent = currentHours.simulatedInstrument.toFixed(1);
                            
                            var simTimeElement = document.getElementById('summarySimTime');
                            simTimeElement.textContent = currentHours.simInstrumentTime.toFixed(1);
                            
                            var container = document.getElementById('summarySimTimeContainer');
                            if (container && !container.querySelector('.sim-max-text')) {
                                var maxText = document.createElement('span');
                                maxText.className = 'sim-max-text';
                                maxText.style.fontSize = '0.6em';
                                maxText.style.color = '#999';
                                maxText.style.marginLeft = '8px';
                                maxText.textContent = '/ 20 max';
                                container.appendChild(maxText);
                            }
                            
                            document.getElementById('summaryInstrumentDualAirplane').textContent = currentHours.instrumentDualAirplane.toFixed(1);
                            document.getElementById('summaryRecentInstrument').textContent = currentHours.recentInstrument.toFixed(1);
                        }
                    } else {
                        currentHours = {};
                    }

                    document.getElementById('aircraftList').innerHTML = '';
                    
                    var settings = budget.settings;
                    document.getElementById('targetCert').value = settings.targetCert || '';
                    document.getElementById('lessonsPerWeek').value = settings.lessonsPerWeek || 2;
                    document.getElementById('instructorRate').value = settings.instructorRate || 60;
                    document.getElementById('simulatorRate').value = settings.simulatorRate || 105;
                    document.getElementById('groundHours').value = settings.groundHours || 0;
                    document.getElementById('headsetCost').value = settings.headsetCost || 0;
                    document.getElementById('booksCost').value = settings.booksCost || 0;
                    document.getElementById('bagCost').value = settings.bagCost || 0;
                    document.getElementById('medicalCost').value = settings.medicalCost || 300;
                    document.getElementById('knowledgeCost').value = settings.knowledgeCost || 250;
                    document.getElementById('checkrideCost').value = settings.checkrideCost || 1000;
                    document.getElementById('insuranceCost').value = settings.insuranceCost || 1150;
                    document.getElementById('foreflightCost').value = settings.foreflightCost || 275;
                    document.getElementById('onlineSchoolCost').value = settings.onlineSchoolCost || 0;
                    document.getElementById('contingencyPercent').value = settings.contingencyPercent || 20;

                    if (settings.aircraft && settings.aircraft.length > 0) {
                        for (var i = 0; i < settings.aircraft.length; i++) {
                            var ac = settings.aircraft[i];
                            addAircraft({
                                id: ac.id,
                                rate: ac.baseRate,
                                type: ac.rateType,
                                fuelPrice: ac.fuelPrice,
                                fuelBurn: ac.fuelBurn
                            });
                            
                            var items = document.querySelectorAll('#aircraftList .aircraft-item');
                            var item = items[items.length - 1];
                            if (item) {
                                item.querySelector('.aircraft-dual-hours').value = ac.dualHours || 0;
                                item.querySelector('.aircraft-solo-hours').value = ac.soloHours || 0;
                                item.querySelector('.aircraft-family-hours').value = ac.familyHours || 0;
                            }
                        }
                    } else {
                        for (var i = 0; i < defaultAircraft.length; i++) {
                            addAircraft(defaultAircraft[i]);
                        }
                    }

                    calculate();
                    
                    preventAutoFill = true;
                    updateDisplay();
                    preventAutoFill = false;
                    
                    document.getElementById('menuDropdown').classList.remove('open');
                    document.getElementById('budgetFileInput').value = '';
                    
                    alert('Budget loaded successfully!');
                } catch (error) {
                    alert('Error loading budget file: ' + error.message);
                    document.getElementById('budgetFileInput').value = '';
                }
            };
            reader.readAsText(file);
        }

        function init() {
            for (var i = 0; i < defaultAircraft.length; i++) {
                addAircraft(defaultAircraft[i]);
            }
            
            document.getElementById('addAircraftBtn').addEventListener('click', function() { addAircraft(); });
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('logbookFile').addEventListener('change', parseLogbook);
            document.getElementById('targetCert').addEventListener('change', updateDisplay);
            
            // Hamburger menu
            document.getElementById('hamburgerMenu').addEventListener('click', toggleMenu);
            document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
            document.getElementById('loadBudgetBtn').addEventListener('click', function() {
                document.getElementById('budgetFileInput').click();
            });
            document.getElementById('budgetFileInput').addEventListener('change', loadBudget);
            
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                var menu = document.getElementById('menuDropdown');
                var hamburger = document.getElementById('hamburgerMenu');
                if (!menu.contains(e.target) && !hamburger.contains(e.target)) {
                    menu.classList.remove('open');
                }
            });
            
            var instrumentHeader = document.getElementById('instrumentDetailsHeader');
            if (instrumentHeader) {
                instrumentHeader.addEventListener('click', function() {
                    var content = document.getElementById('instrumentDetails');
                    var icon = document.getElementById('instrumentDetailsIcon');
                    if (content) content.classList.toggle('open');
                    if (icon) icon.classList.toggle('open');
                });
            }
            
            var inputs = document.querySelectorAll('.input-field');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('input', calculate);
            }
            
            document.getElementById('aircraftList').addEventListener('change', function(e) {
                if (e.target.classList.contains('aircraft-rate-type')) {
                    var aircraftItem = e.target.closest('.aircraft-item');
                    var fuelInputs = aircraftItem.querySelector('.fuel-inputs');
                    if (e.target.value === 'wet') {
                        fuelInputs.classList.add('hidden');
                    } else {
                        fuelInputs.classList.remove('hidden');
                    }
                    calculate();
                }
            });
            
            document.getElementById('aircraftList').addEventListener('input', calculate);
            calculate();
        }

        function exportToPDF() {
            var cert = document.getElementById('targetCert').value;
            var filename = 'flight-training-budget-' + (cert || 'general') + '.pdf';
            
            var element = document.querySelector('.main-container');
            var opt = {
                margin: 0.5,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            var btn = document.getElementById('exportPdfBtn');
            var originalText = btn.textContent;
            btn.textContent = 'Generating PDF...';
            btn.disabled = true;
            
            html2pdf().set(opt).from(element).save().then(function() {
                btn.textContent = originalText;
                btn.disabled = false;
            }).catch(function(error) {
                console.error('PDF generation error:', error);
                btn.textContent = originalText;
                btn.disabled = false;
                alert('Error generating PDF. Please try again.');
            });
        }

        function addAircraft(defaults) {
            defaults = defaults || null;
            var newItem = document.createElement('div');
            newItem.className = 'aircraft-item';

            var aircraftId = defaults ? defaults.id : '';
            var rateType = defaults ? defaults.type : 'wet';
            var baseRate = defaults ? defaults.rate : 120;
            var fuelPrice = defaults ? defaults.fuelPrice : 6.5;
            var fuelBurn = defaults ? defaults.fuelBurn : 8;
            
            var isDefault = defaults && (defaults.id === 'PA28-151' || defaults.id === 'C-172' || defaults.id === 'C-R182' || defaults.id === 'PA28-181');
            var showRemove = !isDefault;

            var html = '<input type="text" class="input-field aircraft-id" placeholder="Aircraft ID" value="' + aircraftId + '">';
            html += '<select class="input-field aircraft-rate-type">';
            html += '<option value="wet"' + (rateType === 'wet' ? ' selected' : '') + '>Wet</option>';
            html += '<option value="dry"' + (rateType === 'dry' ? ' selected' : '') + '>Dry</option>';
            html += '</select>';
            html += '<div class="aircraft-rate-section">';
            html += '<span style="color: #999;">$</span>';
            html += '<input type="number" class="input-field aircraft-base-rate" value="' + baseRate + '">';
            html += '<span class="input-unit">/hr</span>';
            html += '</div>';
            html += showRemove ? '<button class="btn-remove aircraft-remove">Remove</button>' : '<span></span>';
            html += '<div class="fuel-inputs' + (rateType === 'wet' ? ' hidden' : '') + '">';
            html += '<div style="display:flex;align-items:center;gap:10px;"><span style="font-size:0.9em;color:#666;">Fuel: $</span>';
            html += '<input type="number" class="input-field fuel-price" value="' + fuelPrice + '" step="0.01">';
            html += '<span class="input-unit">/gal</span></div>';
            html += '<div style="display:flex;align-items:center;gap:10px;">';
            html += '<input type="number" class="input-field fuel-burn" value="' + fuelBurn + '" step="0.1">';
            html += '<span class="input-unit">gal/hr</span></div></div>';
            html += '<div class="aircraft-item-row2">';
            html += '<div class="hour-input-group"><label>Dual:</label><div class="hour-input-row">';
            html += '<input type="number" class="input-field hour-input aircraft-dual-hours" value="0" step="0.1"><span style="font-size:0.85em;color:#999;">hrs</span></div>';
            html += '<div class="hour-cost-display aircraft-dual-cost">$0</div></div>';
            html += '<div class="hour-input-group"><label>Solo:</label><div class="hour-input-row">';
            html += '<input type="number" class="input-field hour-input aircraft-solo-hours" value="0" step="0.1"><span style="font-size:0.85em;color:#999;">hrs</span></div>';
            html += '<div class="hour-cost-display aircraft-solo-cost">$0</div></div>';
            html += '<div class="hour-input-group"><label>Personal:</label><div class="hour-input-row">';
            html += '<input type="number" class="input-field hour-input aircraft-family-hours" value="0" step="0.1"><span style="font-size:0.85em;color:#999;">hrs</span></div>';
            html += '<div class="hour-cost-display aircraft-family-cost">$0</div></div>';
            html += '<div style="font-size:0.95em;color:#1e40af;font-weight:700;align-self:center;">Total: <span class="aircraft-total-cost">$0</span></div>';
            html += '</div>';

            newItem.innerHTML = html;
            document.getElementById('aircraftList').appendChild(newItem);

            if (showRemove) {
                newItem.querySelector('.aircraft-remove').addEventListener('click', function() {
                    newItem.remove();
                    calculate();
                });
            }
        }

        function parseLogbook(event) {
            var file = event.target.files[0];
            if (!file) return;

            var uploadArea = document.getElementById('fileUploadArea');
            uploadArea.classList.remove('file-upload-error');
            uploadArea.classList.add('file-uploaded');
            uploadArea.querySelector('h3').textContent = 'Processing...';
            uploadArea.querySelector('p').textContent = 'Reading file...';

            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                var lines = text.split('\n');
                
                // Validate ForeFlight export header
                if (lines.length === 0 || !lines[0].includes('ForeFlight Logbook Import')) {
                    uploadArea.classList.remove('file-uploaded');
                    uploadArea.classList.add('file-upload-error');
                    uploadArea.querySelector('h3').textContent = 'Invalid File Format';
                    uploadArea.querySelector('p').textContent = 'This does not appear to be a valid ForeFlight logbook export. Please export your logbook from ForeFlight and try again.';
                    document.getElementById('logbookFile').value = '';
                    return;
                }
                
                var aircraftIdx = -1;
                var flightsIdx = -1;
                
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].includes('Aircraft Table')) {
                        aircraftIdx = i + 1;
                    }
                    if (lines[i].includes('Flights Table')) {
                        flightsIdx = i + 1;
                        break;
                    }
                }
                
                if (aircraftIdx > 0 && flightsIdx > aircraftIdx) {
                    var aircraftCsv = lines.slice(aircraftIdx, flightsIdx - 1).join('\n');
                    Papa.parse(aircraftCsv, {
                        header: true,
                        dynamicTyping: false,
                        skipEmptyLines: true,
                        complete: function(results) {
                            for (var i = 0; i < results.data.length; i++) {
                                var aircraft = results.data[i];
                                if (aircraft.AircraftID) {
                                    aircraftData[aircraft.AircraftID] = {
                                        equipType: aircraft['equipType (FAA)'] || '',
                                        aircraftClass: aircraft['aircraftClass (FAA)'] || ''
                                    };
                                }
                            }
                        }
                    });
                }
                
                if (flightsIdx === -1) {
                    uploadArea.classList.remove('file-uploaded');
                    uploadArea.classList.add('file-upload-error');
                    uploadArea.querySelector('h3').textContent = 'Invalid File Format';
                    uploadArea.querySelector('p').textContent = 'Could not find Flights Table in CSV. Make sure this is a ForeFlight logbook export.';
                    document.getElementById('logbookFile').value = '';
                    return;
                }
                
                Papa.parse(lines.slice(flightsIdx).join('\n'), {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        var validFlights = [];
                        var actualFlights = 0;
                        var simFlights = 0;
                        
                        for (var i = 0; i < results.data.length; i++) {
                            var row = results.data[i];
                            // Only count entries with a date AND actual time logged
                            if (row.Date && (row.TotalTime > 0 || row.SimulatedFlight > 0)) {
                                validFlights.push(row);
                                
                                // Check if it's a simulator flight
                                var aircraftId = row.AircraftID || '';
                                var isSimulator = false;
                                if (aircraftData[aircraftId]) {
                                    var equipType = (aircraftData[aircraftId].equipType || '').toLowerCase();
                                    isSimulator = equipType === 'batd' || equipType === 'aatd' || equipType === 'ftd';
                                }
                                
                                if (isSimulator) {
                                    simFlights++;
                                } else {
                                    actualFlights++;
                                }
                            }
                        }
                        
                        if (validFlights.length === 0) {
                            uploadArea.classList.remove('file-uploaded');
                            uploadArea.classList.add('file-upload-error');
                            uploadArea.querySelector('h3').textContent = 'No Flights Found';
                            uploadArea.querySelector('p').textContent = 'The file was parsed but no valid flights were found. Please check your ForeFlight export.';
                            document.getElementById('logbookFile').value = '';
                            return;
                        }
                        
                        processLogbook(validFlights);
                        uploadArea.querySelector('h3').textContent = 'Logbook Imported: ' + file.name;
                        
                        // Create detailed message showing both actual and simulator flights
                        var message = 'Processed ' + actualFlights + ' flight' + (actualFlights !== 1 ? 's' : '');
                        if (simFlights > 0) {
                            message += ' and ' + simFlights + ' simulator session' + (simFlights !== 1 ? 's' : '');
                        }
                        message += '.<br>Select a certification to auto-fill remaining hours needed.';
                        uploadArea.querySelector('p').innerHTML = message;
                    },
                    error: function(error) {
                        uploadArea.classList.remove('file-uploaded');
                        uploadArea.classList.add('file-upload-error');
                        uploadArea.querySelector('h3').textContent = 'Error Parsing File';
                        uploadArea.querySelector('p').textContent = 'Error: ' + error.message;
                        document.getElementById('logbookFile').value = '';
                    }
                });
            };
            reader.readAsText(file);
        }

        function processLogbook(data) {
            currentHours = {
                totalTime: 0, picTime: 0, picXC: 0, xcTime: 0, dualReceived: 0,
                instrumentTotal: 0, actualInstrument: 0, simulatedInstrument: 0,
                simTime: 0, simInstrumentTime: 0, batdTime: 0, instrumentDualAirplane: 0, recentInstrument: 0, 
                complexTime: 0
            };

            var twoMonthsAgo = new Date();
            twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);

            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                if (!row.Date) continue;
                
                var totalTime = row.TotalTime || 0;
                var pic = row.PIC || 0;
                var xc = row.CrossCountry || 0;
                var dual = row.DualReceived || 0;
                var actual = row.ActualInstrument || 0;
                var simulated = row.SimulatedInstrument || 0;
                var simulator = row.SimulatedFlight || 0;
                var complex = row['[Hours]Complex'] || 0;
                var aircraftId = row.AircraftID || '';

                currentHours.totalTime += totalTime;
                currentHours.picTime += pic;
                currentHours.xcTime += xc;
                currentHours.dualReceived += dual;
                currentHours.complexTime += complex;

                var isSimulator = false;
                var isBATD = false;
                if (aircraftData[aircraftId]) {
                    var equipType = (aircraftData[aircraftId].equipType || '').toLowerCase();
                    isSimulator = equipType === 'batd' || equipType === 'aatd' || equipType === 'ftd';
                    isBATD = equipType === 'batd';
                }
                
                if (isSimulator) {
                    currentHours.simTime += simulator;
                    currentHours.simInstrumentTime += simulated;
                    
                    if (isBATD && simulator > 0) {
                        currentHours.batdTime += simulator;
                    }
                    
                    currentHours.instrumentTotal += simulated;
                } else {
                    currentHours.actualInstrument += actual;
                    currentHours.simulatedInstrument += simulated;
                    currentHours.instrumentTotal += actual + simulated;
                }

                if (pic > 0 && xc > 0) {
                    currentHours.picXC += Math.min(pic, xc, totalTime);
                }

                if (!isSimulator && dual > 0 && (actual > 0 || simulated > 0)) {
                    currentHours.instrumentDualAirplane += Math.min(dual, actual + simulated, totalTime);
                }

                var flightDate = new Date(row.Date);
                if (!isSimulator && flightDate >= twoMonthsAgo && dual > 0 && (actual > 0 || simulated > 0)) {
                    currentHours.recentInstrument += Math.min(dual, actual + simulated, totalTime);
                }
            }

            document.getElementById('logbookSummary').style.display = 'block';
            document.getElementById('summaryTotalTime').textContent = currentHours.totalTime.toFixed(1);
            document.getElementById('summaryPICTime').textContent = currentHours.picTime.toFixed(1);
            document.getElementById('summaryXCTime').textContent = currentHours.picXC.toFixed(1);
            document.getElementById('summaryDualTime').textContent = currentHours.dualReceived.toFixed(1);
            
            document.getElementById('summaryInstrumentTime').textContent = currentHours.instrumentTotal.toFixed(1);
            document.getElementById('summaryActualInstrument').textContent = currentHours.actualInstrument.toFixed(1);
            document.getElementById('summarySimulatedInstrument').textContent = currentHours.simulatedInstrument.toFixed(1);
            
            var simTimeElement = document.getElementById('summarySimTime');
            simTimeElement.textContent = currentHours.simInstrumentTime.toFixed(1);
            
            var container = document.getElementById('summarySimTimeContainer');
            if (container && !container.querySelector('.sim-max-text')) {
                var maxText = document.createElement('span');
                maxText.className = 'sim-max-text';
                maxText.style.fontSize = '0.6em';
                maxText.style.color = '#999';
                maxText.style.marginLeft = '8px';
                maxText.textContent = '/ 20 max';
                container.appendChild(maxText);
            }
            
            document.getElementById('summaryInstrumentDualAirplane').textContent = currentHours.instrumentDualAirplane.toFixed(1);
            document.getElementById('summaryRecentInstrument').textContent = currentHours.recentInstrument.toFixed(1);

            updateDisplay();
        }

        function updateDisplay() {
            var cert = document.getElementById('targetCert').value;
            if (!cert) {
                document.getElementById('requirementsList').style.display = 'none';
                return;
            }

            var requirements = {
                ir: [
                    { name: '50 hours PIC cross country', required: 50, field: 'picXC', type: 'solo' },
                    { name: '10 hours PIC XC in airplanes', required: 10, field: 'picXC', type: 'solo' },
                    { name: '40 hours actual or simulated instrument', required: 40, field: 'instrumentTotal', type: 'dual', showBreakdown: true },
                    { name: '15 hours instrument training from instructor', required: 15, field: 'instrumentDualAirplane', type: 'dual' },
                    { name: 'One 250nm XC: 3 approaches, 3 approach types', required: 1, field: 'longXC', type: 'dual', isSpecial: true },
                    { name: '3 hours instrument training (last 2 months)', required: 3, field: 'recentInstrument', type: 'dual' }
                ],
                cpl: [
                    { name: '250 hours total time', required: 250, field: 'totalTime', type: 'solo' },
                    { name: '100 hours PIC', required: 100, field: 'picTime', type: 'solo' },
                    { name: '50 hours PIC in airplanes', required: 50, field: 'picTime', type: 'solo' },
                    { name: '50 hours PIC cross country', required: 50, field: 'picXC', type: 'solo' },
                    { name: '10 hours PIC XC in airplanes', required: 10, field: 'picXC', type: 'solo' },
                    { name: '20 hours training (total)', required: 20, field: 'dualReceived', type: 'dual' },
                    { name: '10 hours instrument training', required: 10, field: 'instrumentDualAirplane', type: 'dual' },
                    { name: '5 hours instrument in single engine', required: 5, field: 'instrumentDualAirplane', type: 'dual' },
                    { name: '10 hours complex or TAA', required: 10, field: 'complexTime', type: 'dual' },
                    { name: 'One 2hr day XC (100nm+ from origin)', required: 1, field: 'dayXC', type: 'dual', isSpecial: true },
                    { name: 'One 2hr night XC (100nm+ from origin)', required: 1, field: 'nightXC', type: 'dual', isSpecial: true },
                    { name: '3 hours training (last 2 months)', required: 3, field: 'recentInstrument', type: 'dual' },
                    { name: '10 hours solo or PIC time', required: 10, field: 'picTime', type: 'solo' },
                    { name: 'One solo 300nm XC (one leg 250nm+)', required: 1, field: 'soloLongXC', type: 'solo', isSpecial: true },
                    { name: '5 hours night VFR (10 T/O and landings)', required: 5, field: 'nightTime', type: 'solo', isSpecial: true }
                ],
                cfi: [
                    { name: '250 hours total time', required: 250, field: 'totalTime', type: 'solo' },
                    { name: '100 hours PIC', required: 100, field: 'picTime', type: 'solo' },
                    { name: '50 hours PIC cross country', required: 50, field: 'picXC', type: 'solo' },
                    { name: '15 hours instrument (in training)', required: 15, field: 'instrumentTotal', type: 'dual' }
                ]
            };

            var reqs = requirements[cert];
            if (!reqs) return;

            if (currentHours.totalTime) {
                document.getElementById('requirementsList').style.display = 'block';
            }
            
            var html = '';
            var totalDualNeeded = 0;
            var totalSoloNeeded = 0;
            
            for (var i = 0; i < reqs.length; i++) {
                var req = reqs[i];
                var current = currentHours[req.field] || 0;
                var needed = Math.max(req.required - current, 0);
                var pct = Math.min((current / req.required) * 100, 100);
                
                if (needed > 0 && !req.isSpecial) {
                    if (req.type === 'dual') {
                        totalDualNeeded = Math.max(totalDualNeeded, needed);
                    } else {
                        totalSoloNeeded = Math.max(totalSoloNeeded, needed);
                    }
                }
                
                if (currentHours.totalTime) {
                    var status = pct >= 100 ? 'completed' : (pct > 0 ? 'in-progress' : 'not-started');
                    var badge = pct >= 100 ? 'badge-completed' : (pct > 0 ? 'badge-in-progress' : 'badge-not-started');
                    var badgeText = pct >= 100 ? 'Complete' : (pct > 0 ? 'In Progress' : 'Not Started');

                    html += '<div class="requirement-item ' + status + '">';
                    html += '<div class="requirement-header"><div class="requirement-title">' + req.name + '</div>';
                    html += '<div class="requirement-badge ' + badge + '">' + badgeText + '</div></div>';
                    
                    if (req.isSpecial) {
                        html += '<div class="requirement-stats"><span>Special flight requirement</span>';
                        html += '<span>' + (pct >= 100 ? 'Completed' : 'Not completed') + '</span></div>';
                    } else {
                        html += '<div class="requirement-stats"><span>' + current.toFixed(1) + ' / ' + req.required + ' hrs</span>';
                        html += '<span>' + needed.toFixed(1) + ' hrs needed</span></div>';
                    }
                    
                    if (req.showBreakdown && req.field === 'instrumentTotal') {
                        html += '<div class="requirement-breakdown">';
                        html += '(' + currentHours.batdTime.toFixed(1) + ' BATD hours included)<br>';
                        html += '(' + currentHours.simInstrumentTime.toFixed(1) + ' total simulator hours included)';
                        html += '</div>';
                    }
                    
                    html += '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div></div>';
                }
            }

            if (currentHours.totalTime) {
                document.getElementById('requirementsContent').innerHTML = html;
            }
            
            if (!preventAutoFill) {
                var aircraftItems = document.querySelectorAll('#aircraftList .aircraft-item');
                if (aircraftItems.length > 0) {
                    var firstAircraft = aircraftItems[0];
                    var dualInput = firstAircraft.querySelector('.aircraft-dual-hours');
                    var soloInput = firstAircraft.querySelector('.aircraft-solo-hours');
                    
                    if (dualInput) dualInput.value = totalDualNeeded.toFixed(1);
                    if (soloInput) soloInput.value = totalSoloNeeded.toFixed(1);
                    
                    calculate();
                }
            }
        }

        function calculate() {
            var groundHours = parseFloat(document.getElementById('groundHours').value) || 0;
            var instructorRate = parseFloat(document.getElementById('instructorRate').value) || 0;
            var totalFlightTrainingCost = 0;
            var totalFamilyFlightCost = 0;
            var totalDualHours = 0;
            var totalSoloHours = 0;
            var totalFamilyHours = 0;

            var aircraftItems = document.querySelectorAll('#aircraftList .aircraft-item');
            for (var i = 0; i < aircraftItems.length; i++) {
                var item = aircraftItems[i];
                var rateType = item.querySelector('.aircraft-rate-type').value;
                var aircraftRate = parseFloat(item.querySelector('.aircraft-base-rate').value) || 0;

                if (rateType === 'dry') {
                    var fuelPrice = parseFloat(item.querySelector('.fuel-price').value) || 0;
                    var fuelBurn = parseFloat(item.querySelector('.fuel-burn').value) || 0;
                    aircraftRate = aircraftRate + (fuelPrice * fuelBurn);
                }

                var dualHours = parseFloat(item.querySelector('.aircraft-dual-hours').value) || 0;
                var soloHours = parseFloat(item.querySelector('.aircraft-solo-hours').value) || 0;
                var familyHours = parseFloat(item.querySelector('.aircraft-family-hours').value) || 0;

                var dualCost = dualHours * (aircraftRate + instructorRate);
                var soloCost = soloHours * aircraftRate;
                var familyCost = familyHours * aircraftRate;
                var aircraftTotal = dualCost + soloCost + familyCost;

                item.querySelector('.aircraft-dual-cost').textContent = '$' + dualCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                item.querySelector('.aircraft-solo-cost').textContent = '$' + soloCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                item.querySelector('.aircraft-family-cost').textContent = '$' + familyCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                item.querySelector('.aircraft-total-cost').textContent = '$' + aircraftTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

                totalFlightTrainingCost += dualCost + soloCost;
                totalFamilyFlightCost += familyCost;
                totalDualHours += dualHours;
                totalSoloHours += soloHours;
                totalFamilyHours += familyHours;
            }

            var groundCost = groundHours * instructorRate;
            var flightTrainingTotal = totalFlightTrainingCost + groundCost;

            document.getElementById('dualHours').value = totalDualHours.toFixed(1);
            document.getElementById('soloHours').value = totalSoloHours.toFixed(1);
            document.getElementById('familyHours').value = totalFamilyHours.toFixed(1);

            var headsetCost = parseFloat(document.getElementById('headsetCost').value) || 0;
            var booksCost = parseFloat(document.getElementById('booksCost').value) || 0;
            var bagCost = parseFloat(document.getElementById('bagCost').value) || 0;
            var gearTotal = headsetCost + booksCost + bagCost;

            var medicalCost = parseFloat(document.getElementById('medicalCost').value) || 0;
            var knowledgeCost = parseFloat(document.getElementById('knowledgeCost').value) || 0;
            var checkrideCost = parseFloat(document.getElementById('checkrideCost').value) || 0;
            var insuranceCost = parseFloat(document.getElementById('insuranceCost').value) || 0;
            var examsTotal = medicalCost + knowledgeCost + checkrideCost + insuranceCost;

            var foreflightCost = parseFloat(document.getElementById('foreflightCost').value) || 0;
            var onlineSchoolCost = parseFloat(document.getElementById('onlineSchoolCost').value) || 0;
            var subscriptionsTotal = foreflightCost + onlineSchoolCost;

            var subtotal = flightTrainingTotal + totalFamilyFlightCost + gearTotal + examsTotal + subscriptionsTotal;
            var contingencyPercent = parseFloat(document.getElementById('contingencyPercent').value) || 0;
            var contingency = subtotal * (contingencyPercent / 100);
            var grandTotal = subtotal + contingency;

            document.getElementById('flightTrainingCost').textContent = '$' + flightTrainingTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('familyFlightCost').textContent = '$' + totalFamilyFlightCost.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('gearCost').textContent = '$' + gearTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('examsCost').textContent = '$' + examsTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('subscriptionsCost').textContent = '$' + subscriptionsTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('subtotalCost').textContent = '$' + subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('contingencyCost').textContent = '$' + contingency.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('totalCost').textContent = '$' + grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            var lessonsPerWeek = parseFloat(document.getElementById('lessonsPerWeek').value) || 2;
            var totalTrainingHours = totalDualHours + totalSoloHours;
            var avgHoursPerLesson = 1.5;
            
            if (totalTrainingHours > 0) {
                var weeksToComplete = totalTrainingHours / (lessonsPerWeek * avgHoursPerLesson);
                var monthsToComplete = weeksToComplete / 4.33;
                
                var trainingBudget = flightTrainingTotal + gearTotal + examsTotal + subscriptionsTotal;
                var trainingContingency = trainingBudget * (contingencyPercent / 100);
                var totalTrainingBudget = trainingBudget + trainingContingency;
                var monthlyBudget = totalTrainingBudget / monthsToComplete;
                
                document.getElementById('estimatedMonths').textContent = '~ ' + Math.ceil(monthsToComplete) + ' Months';
                document.getElementById('monthlyBudget').textContent = '$' + monthlyBudget.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                document.getElementById('estimatedMonths').textContent = '~ 0 Months';
                document.getElementById('monthlyBudget').textContent = '$0.00';
            }

            updateBudgetChart(flightTrainingTotal, totalFamilyFlightCost, gearTotal, examsTotal, subscriptionsTotal, contingency);
        }

        function updateBudgetChart(training, family, gear, exams, subs, contingency) {
            var ctx = document.getElementById('budgetChart');
            if (!ctx) return;

            var chartData = {
                labels: ['Flight Training', 'Personal', 'Gear', 'Exams', 'Subscriptions', 'Contingency'],
                datasets: [{
                    data: [training, family, gear, exams, subs, contingency],
                    backgroundColor: ['#1e40af', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#ec4899'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            };

            if (budgetChart) {
                budgetChart.data = chartData;
                budgetChart.update();
            } else {
                budgetChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var total = 0;
                                        for (var i = 0; i < context.dataset.data.length; i++) {
                                            total += context.dataset.data[i];
                                        }
                                        var pct = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': $' + context.parsed.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' (' + pct + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            var legendDiv = document.getElementById('chartLegend');
            var colors = chartData.datasets[0].backgroundColor;
            var total = 0;
            for (var i = 0; i < chartData.datasets[0].data.length; i++) {
                total += chartData.datasets[0].data[i];
            }
            
            var html = '';
            for (var i = 0; i < chartData.labels.length; i++) {
                var value = chartData.datasets[0].data[i];
                var pct = ((value / total) * 100).toFixed(1);
                html += '<div class="legend-item"><div class="legend-color" style="background:' + colors[i] + '"></div>';
                html += '<div class="legend-label">' + chartData.labels[i] + '</div>';
                html += '<div class="legend-value">$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' (' + pct + '%)</div></div>';
            }
            legendDiv.innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>