# Dependency Management Guide

## Overview

This project uses a centralized dependency management system via [`dependencies.json`](../dependencies.json) to avoid hardcoded version numbers scattered across multiple files.

## The Problem We Solved

### Before (Hardcoded Versions):
```yaml
# .github/workflows/update-dependencies.yml
curl -L -o app/libs/papaparse.min.js \
  https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js
                                                    ^^^^^^^ hardcoded!

curl -L -o app/libs/chart.umd.min.js \
  https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js
                                        ^^^^^ hardcoded!
```

**Issues:**
- ❌ Version numbers duplicated across files
- ❌ Easy to update one place and forget others
- ❌ No single source of truth
- ❌ Hard to see what versions are in use
- ❌ Manual updates in multiple locations

### After (Centralized Management):
```json
// dependencies.json
{
  "libraries": {
    "papaparse": {
      "version": "5.4.1",  // ← Single source of truth
      "url": "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/{VERSION}/papaparse.min.js"
    }
  }
}
```

**Benefits:**
- ✅ Single source of truth
- ✅ Version visible at a glance
- ✅ Update once, applies everywhere
- ✅ Self-documenting
- ✅ Automated workflows read from JSON

---

## File Structure

```
flight_budget/
├── dependencies.json               ← Source of truth
├── app/libs/
│   ├── papaparse.min.js
│   ├── chart.umd.min.js
│   ├── html2pdf.bundle.min.js
│   └── VERSIONS.txt               ← Auto-generated by workflow
└── .github/workflows/
    └── update-dependencies.yml    ← Reads from dependencies.json
```

---

## dependencies.json Structure

```json
{
  "name": "flight-budget-dependencies",
  "description": "Centralized dependency version management",
  "updated": "2025-11-27",
  "libraries": {
    "papaparse": {
      "version": "5.4.1",
      "url": "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/{VERSION}/papaparse.min.js",
      "filename": "papaparse.min.js",
      "description": "CSV parsing library",
      "license": "MIT",
      "homepage": "https://www.papaparse.com/",
      "size": "~19KB"
    }
  },
  "deployment": {
    "docker": {
      "base_image": "nginx:alpine",
      "base_version": "latest"
    }
  }
}
```

### Field Descriptions

| Field | Purpose | Example |
|-------|---------|---------|
| `version` | Dependency version | `"5.4.1"` |
| `url` | Download URL template | `"https://.../{VERSION}/lib.js"` |
| `filename` | Output filename | `"papaparse.min.js"` |
| `description` | What it does | `"CSV parsing library"` |
| `license` | Software license | `"MIT"` |
| `homepage` | Official docs | `"https://www.papaparse.com/"` |
| `size` | Approximate size | `"~19KB"` |

**Note:** The `{VERSION}` placeholder in URLs is replaced by the workflow.

---

## How to Update Dependencies

### Method 1: Update Version Numbers

1. **Edit `dependencies.json`**:
   ```json
   {
     "libraries": {
       "chartjs": {
         "version": "4.4.0",  // ← Change to "4.5.0"
         ...
       }
     }
   }
   ```

2. **Commit and push**:
   ```bash
   git add dependencies.json
   git commit -m "chore: update Chart.js to v4.5.0"
   git push origin main
   ```

3. **Trigger workflow**:
   - **Option A**: Wait for weekly scheduled run (Sundays 2AM UTC)
   - **Option B**: Manually trigger via GitHub Actions UI

4. **Review PR**:
   - Workflow creates a PR with updated libraries
   - Review changes
   - Merge if tests pass

### Method 2: Add New Dependency

1. **Add to `dependencies.json`**:
   ```json
   {
     "libraries": {
       "moment": {
         "version": "2.29.4",
         "url": "https://cdnjs.cloudflare.com/ajax/libs/moment.js/{VERSION}/moment.min.js",
         "filename": "moment.min.js",
         "description": "Date manipulation library",
         "license": "MIT",
         "homepage": "https://momentjs.com/",
         "size": "~68KB"
       }
     }
   }
   ```

2. **Update workflow**:
   Add download step in `.github/workflows/update-dependencies.yml`

3. **Update app**:
   Add `<script src="libs/moment.min.js"></script>` to `app/index.html`

---

## GitHub Actions Workflow

### How It Works

```yaml
1. Read dependencies.json
   ↓
2. Parse version numbers and URLs
   ↓
3. Download each library with correct version
   ↓
4. Verify downloads succeeded
   ↓
5. Generate VERSIONS.txt report
   ↓
6. Create PR if changes detected
```

### Workflow Features

✅ **Reads from JSON**: All versions from `dependencies.json`
✅ **URL templating**: Replaces `{VERSION}` placeholder
✅ **Verification**: Checks files downloaded successfully
✅ **Version report**: Auto-generates `app/libs/VERSIONS.txt`
✅ **Auto PR**: Creates PR when dependencies change
✅ **Weekly schedule**: Runs every Sunday at 2AM UTC
✅ **Manual trigger**: Can run on-demand

### Example Workflow Output

```
Read dependencies from JSON
  papaparse_version: 5.4.1
  chartjs_version: 4.4.0
  html2pdf_version: 0.10.1

Download PapaParse v5.4.1...
✓ PapaParse v5.4.1 downloaded

Download Chart.js v4.4.0...
✓ Chart.js v4.4.0 downloaded

Download html2pdf.js v0.10.1...
✓ html2pdf.js v0.10.1 downloaded

Verify downloads...
✓ All files verified

Generate dependency report...
# Dependency Versions
# Generated: 2025-11-27 02:00:00 UTC
# Source: dependencies.json

PapaParse: 5.4.1
Chart.js: 4.4.0
html2pdf.js: 0.10.1
```

---

## VERSIONS.txt File

Auto-generated file that documents current versions:

```
# Dependency Versions
# Generated: 2025-11-27 02:00:00 UTC
# Source: dependencies.json

PapaParse: 5.4.1
Chart.js: 4.4.0
html2pdf.js: 0.10.1

# To update versions, edit dependencies.json in the repository root
```

**Location**: `app/libs/VERSIONS.txt`

**Purpose**:
- Quick reference for current versions
- Included in Docker image
- Timestamp of last update
- Points back to `dependencies.json`

---

## Checking Current Versions

### Method 1: View dependencies.json
```bash
cat dependencies.json | jq '.libraries | map_values(.version)'
```

Output:
```json
{
  "papaparse": "5.4.1",
  "chartjs": "4.4.0",
  "html2pdf": "0.10.1"
}
```

### Method 2: View VERSIONS.txt
```bash
cat app/libs/VERSIONS.txt
```

### Method 3: Check in browser
Open browser console:
```javascript
// Check if libraries loaded
console.log('PapaParse:', typeof Papa !== 'undefined');
console.log('Chart.js:', typeof Chart !== 'undefined');
console.log('html2pdf:', typeof html2pdf !== 'undefined');
```

---

## Updating Process Flow

```
Developer edits dependencies.json
         ↓
   Commits & pushes
         ↓
GitHub Actions workflow triggered
         ↓
   Reads dependencies.json
         ↓
Downloads libraries with new versions
         ↓
   Generates VERSIONS.txt
         ↓
   Creates Pull Request
         ↓
  Team reviews changes
         ↓
      PR merged
         ↓
Docker build triggered
         ↓
  Image pushed to Docker Hub
         ↓
Portainer webhook deploys
         ↓
   Production updated! ✅
```

---

## Best Practices

### ✅ Do This

1. **Always update `dependencies.json` first**
   ```bash
   # Edit version
   vim dependencies.json

   # Commit
   git commit -m "chore: update Chart.js to v4.5.0"
   ```

2. **Test locally before pushing**
   ```bash
   # Download new version manually
   curl -L -o app/libs/chart.umd.min.js https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js

   # Test app
   open app/index.html

   # If works, update dependencies.json and push
   ```

3. **Use semantic versioning**
   ```json
   "version": "4.4.0"  // ✅ Good
   "version": "latest" // ❌ Bad - not reproducible
   ```

4. **Document breaking changes**
   ```json
   {
     "chartjs": {
       "version": "5.0.0",
       "notes": "Breaking changes - requires code updates"
     }
   }
   ```

### ❌ Don't Do This

1. **Don't hardcode versions in workflows**
   ```yaml
   # ❌ Bad
   curl https://cdn.../chart.js@4.4.0/chart.min.js

   # ✅ Good
   VERSION=$(jq -r '.libraries.chartjs.version' dependencies.json)
   curl https://cdn.../chart.js@$VERSION/chart.min.js
   ```

2. **Don't update files directly without updating JSON**
   ```bash
   # ❌ Bad
   curl -o app/libs/chart.js https://...

   # ✅ Good
   # 1. Edit dependencies.json
   # 2. Let workflow update files
   ```

3. **Don't skip testing**
   - Always test after version updates
   - Check browser console for errors
   - Verify all features work

---

## Troubleshooting

### Workflow Failed to Download

**Symptom**: Error message "PapaParse download failed"

**Solutions**:
1. Check URL template in `dependencies.json`
2. Verify version exists on CDN
3. Check CDN is accessible

```bash
# Test URL manually
VERSION="5.4.1"
URL="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/${VERSION}/papaparse.min.js"
curl -I "$URL"
```

### Version Not Found

**Symptom**: 404 error

**Solutions**:
1. Check version number is correct
2. Visit library homepage for valid versions
3. Update URL template if CDN changed

### App Broken After Update

**Symptom**: JavaScript errors in console

**Solutions**:
1. Check for breaking changes in library changelog
2. Rollback to previous version in `dependencies.json`
3. Update app code to match new API

```bash
# Quick rollback
git revert HEAD
git push
```

---

## Future Enhancements

### Potential Improvements

1. **Automated version checking**
   - Check for new versions automatically
   - Create PR when updates available

2. **Security scanning**
   - Check for known vulnerabilities
   - Alert on security updates

3. **License compliance**
   - Verify licenses are compatible
   - Generate attribution file

4. **Size monitoring**
   - Alert if bundle size increases significantly
   - Track size over time

5. **Dependency graph**
   - Visualize dependencies
   - Check for conflicts

---

## FAQ

**Q: Why not use npm/yarn?**
A: This is a static site with no build process. Vendoring libraries keeps it simple.

**Q: Why not use CDN links directly?**
A: Local copies ensure offline functionality and protect against CDN outages.

**Q: How often are dependencies checked?**
A: Weekly automated check + manual trigger option.

**Q: Can I pin to a specific version?**
A: Yes! That's the whole point. Edit `dependencies.json` with exact version.

**Q: What if a library is removed from CDN?**
A: Our local copies protect us. But we should migrate if the project is abandoned.

**Q: Can I add a new dependency?**
A: Yes! Add to `dependencies.json`, update workflow, update HTML. See "Method 2" above.

---

## Summary

✅ **Single source of truth**: `dependencies.json`
✅ **Automated updates**: GitHub Actions workflow
✅ **Version tracking**: Auto-generated `VERSIONS.txt`
✅ **Easy to update**: Edit one file, push, done
✅ **Self-documenting**: Versions visible at a glance

**To update a dependency:**
1. Edit `dependencies.json`
2. Push to GitHub
3. Review auto-generated PR
4. Merge and deploy

Simple, maintainable, professional. ✨

---

**Last Updated**: 2025-11-27
**Maintainer**: ryakel
